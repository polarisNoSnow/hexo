---
title: 浅谈乐悲观锁
date: 2019-05-10 18:05:00
tags:
- 思想机制
categories:
- 技术
---

# 简介
最开始接触加锁机制，还是在学oracle数据库的时候for update，因为存在会话丢失锁表的情况后来改用rowid的方式。

>for update：直接对相应的数据加上行级锁，若遇到断网、忘记提交等情况，会比较容易锁表。

>rowid： 运行后并未给数据加上行级锁（通过物理地址去确定某一行数据），但可以编辑数据，提交事务的瞬间完成上锁、提交、解锁等动作，不易发生锁表。

在公司做项目基本都是采用带版本号更新的方式。实际上，在很多地方都采用了类似的做法。

# 悲观锁
如上面的for update,rowid都是一种悲观锁的方式，具有强烈的独占和排他特性，基本都是依靠数据库底层实现，在数据处理过程中数据会一直被锁定。最经典的例子就是ATM转账

# 乐观锁
乐观锁机制则采取比较宽松的加锁机制,不直接锁定数据，而是带着版本或状态等去比较 然后更新。当然这只是一种思想，有很多实现的手段。<br/>

**常用方式：**
1.带状态、版本号更新 
如JPA中的javax.persistence.Version注解 

2.CAS
在java底层Atomic相关包中存在一个compareAndSet(int expect, int update)的方法，它的基本思想就是先比较再更新（底层调用的是非安全的cpp函数，以及hpp函数，最终由cpu完成）
