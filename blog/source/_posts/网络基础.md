---
title: 网络基础
date: 2019-06-03 16:36:58
tags:
- TCP
- HTTP
- 网络
categories:
- 技术
---

## TCP三次握手，四次挥手
参考：https://blog.csdn.net/qq_38950316/article/details/81087809

TCP数据传输：IP首部 + IP数据部分（TCP首部 +TCP数据部分）

其中TCP报文段

（1）序号（sequence number）：Seq序号，占32位，用来标识从TCP源端向目的端发送的字节流，发起方发送数据时对此进行标记。

（2）确认号（acknowledgement number）：Ack序号，占32位，只有ACK标志位为1时，确认序号字段才有效，Ack=Seq+1。

（3）标志位（Flags）：共6个，即URG、ACK、PSH、RST、SYN、FIN等。具体含义如下

标志位（Flags）

URG	紧急指针是否有效。为1，表示某一位需要被优先处理
ACK	确认号是否有效，一般置为1。
PSH	提示接收端应用程序立即从TCP缓冲区把数据读走。
RST	对方要求重新建立连接，复位。
SYN	请求建立连接，并在其序列号的字段进行序列号的初始值设定。建立连接，设置为1
FIN    	希望断开连接。

PS：ACK、SYN和FIN这些大写的单词表示标志位，其值要么是1，要么是0；ack、seq小写的单词表示序号。

**三次握手**

- 第一次握手：建立连接时，客户端发送SYN包（seq=j）到服务器，并进入SYN_SENT状态，等待服务器确认；SYN：同步序列编号（Synchronize Sequence Numbers）；
- 第二次握手：服务器收到SYN包，必须确认客户的SYN（ack=j+1）即ACK包，同时自己也发送一个SYN包（seq=k），即SYN+ACK包，此时服务器进入SYN_RECV状态；
- 第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=k+1），此包发送完毕，客户端和服务器进入ESTABLISHED（TCP连接成功）状态，完成三次握手。

**四次挥手**
1.客户端发出连接释放报文，FIN=1，进入FIN-WAIT-1（终止等待1）状态；
2.服务器收到连接释放报文，发出确认报文，ACK=1，进入了CLOSE-WAIT（关闭等待）状态；
3.客户端收到服务器的确认请求，进入FIN-WAIT-2（终止等待2）状态，等待服务器发送连接释放报文；

4.数据发送完毕后，服务器发送连接释放报文，FIN=1，进入了LAST-ACK（最后确认）状态；

5.客户端收到服务器的连接释放报文后，必须发出确认，ACK=1，进入了TIME-WAIT（时间等待）状态（此时TCP连接还没有释放，必须经过2∗∗MSL（最长报文段寿命）的时间后，当客户端撤销相应的TCB后，才进入CLOSED状态）

6.服务器只要收到了客户端发出的确认，立即进入CLOSED状态。

简单过程：双方都必须发送FIN报文+ACK报文，所以需要四次传输



为什么是三次握手不是两次，简单来说就是服务端为了确认客户端已经收到了我的应答，否则存在客户端宕机的情况下服务端不知情而建立连接并发送消息。

## HTTP长短连接

**HTTP/1.0中，默认使用的是短连接, HTTP/1.1起，默认使用长连接**

```
Connection:keep-alive
```

**HTTP协议的长连接和短连接，实质上是TCP协议的长连接和短连接** 

TCP 本身并没有长短连接的区别，长短与否，完全取决于我们怎么用它。
- 短连接

每次通信时，创建 Socket；一次通信结束，调用 socket.close()。这就是一般意义上的短连接，短连接的好处是管理起来比较简单，存在的连接都是可用的连接，不需要额外的控制手段。

- 长连接

每次通信完毕后，不会关闭连接，这样就可以做到连接的复用。长连接的好处便是省去了创建连接的耗时。



**TCP还设有一个保活计时器**

服务器每收到一次客户端的请求后都会重新复位这个计时器，时间通常是设置为2小时，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒钟发送一次。若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接